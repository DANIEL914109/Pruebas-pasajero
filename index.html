<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Pasajero - Moviit</title>
  <style>
    #map {
      height: 90vh;
      width: 100%;
    }
    body {
      margin: 0;
      font-family: sans-serif;
      text-align: center;
    }
    select {
      margin: 1em;
      padding: 0.5em;
      font-size: 1em;
    }
    /* Estilos del botón y modal de video */
    #btnVideo {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 5;
      padding: 30px 45px;
      font-size: 30px;
      background-color: #1976d2;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #videoModal {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      z-index: 10;
      justify-content: center;
      align-items: center;
    }
    #videoModal div {
      position: relative;
      width: 80%;
      max-width: 800px;
    }
    #cerrarVideo {
      position: absolute;
      top: -30px;
      right: -30px;
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h2>Ubicación del Transporte</h2>
  <label for="ruta">Selecciona la ruta:</label>
  <select id="ruta">
    <option value="">-- Elige una ruta --</option>
    <option value="LM-V01">LM-V01(Central vieja)</option>
    <option value="LM-V01R">LM-V01(La noria)</option>
    <option value="C47-V1">C47-V1(Dos templos)</option>
  </select>

  <div id="map"></div>

  <!-- Botón de video -->
  <button id="btnVideo">Ver video</button>

  <!-- Modal de video -->
  <div id="videoModal">
    <div>
      <button id="cerrarVideo">X</button>
      <video id="videoRecorrido" width="100%" controls>
        <source src="" type="video/mp4">
        Tu navegador no soporta video HTML5.
      </video>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, off } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCcVJ7HJM3gS10BcCNdxGmRx5ypzTizNYg",
      authDomain: "moviit-928f2.firebaseapp.com",
      databaseURL: "https://moviit-928f2-default-rtdb.firebaseio.com",
      projectId: "moviit-928f2",
      storageBucket: "moviit-928f2.appspot.com",
      messagingSenderId: "753483147976",
      appId: "1:753483147976:web:1057942a7b78444ebf13fd"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    let map;
    let markers = {};
    let currentRef = null;
    let directionsService;
    let directionsRenderer;
    let rutaSeleccionadaGlobal = null;

    function obtenerDatosRuta(rutaSeleccionada) {
      if (rutaSeleccionada === "LM-V01") {
        return {
          origen: { lat: 20.452031, lng: -103.420501 },
          destino: { lat: 20.662764, lng: -103.345814 }, 
          waypoints: [
            { location: { lat: 20.664631, lng: -103.370325 }, stopover: true },
            { location: { lat: 20.658245, lng: -103.353675 }, stopover: true },
            { location: { lat: 20.662724, lng: -103.350227 }, stopover: true },
          ]
        };
      } else if (rutaSeleccionada === "LM-V01R") {
        return {
          origen: { lat: 20.662764, lng: -103.345814 },
          destino: { lat: 20.452093, lng: -103.420612 },   
          waypoints: [
            { location: { lat: 20.663007, lng: -103.352604 }, stopover: true },
            { location: { lat: 20.658398, lng: -103.353717 }, stopover: true },
            { location: { lat: 20.665238, lng: -103.372348 }, stopover: true },   
            { location: { lat: 20.476155, lng: -103.440711 }, stopover: true },
            { location: { lat: 20.467975, lng: -103.440510 }, stopover: true },
            { location: { lat: 20.458643, lng: -103.440889 }, stopover: true },
            { location: { lat: 20.460323, lng: -103.425680 }, stopover: true },
          ] 
        };
      } else if (rutaSeleccionada === "C47-V1") {
        return {
          origen: { lat: 20.594628, lng: -103.334091 },
          destino: { lat: 20.669754, lng: -103.347026 },    
          waypoints: [
            { location: { lat: 20.606665, lng: -103.337170  }, stopover: true },
            { location: { lat: 20.609337, lng: -103.336780  }, stopover: true },
            { location: { lat: 20.614133, lng: -103.331507 }, stopover: true },
            { location: { lat: 20.616730, lng: -103.332171 }, stopover: true },
            { location: { lat: 20.621239, lng: -103.328962 }, stopover: true },
            { location: { lat: 20.622590, lng: -103.332670 }, stopover: true },
            { location: { lat: 20.623540, lng: -103.331908 }, stopover: true },
            { location: { lat: 20.626496, lng: -103.330191 }, stopover: true },
          ]
        };
      }
      return null;
    }

    window.initMap = function () {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 19.4326, lng: -99.1332 },
        zoom: 15
      });

      directionsService = new google.maps.DirectionsService();

      // Seguimiento del usuario
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
          (position) => {
            const userPos = { lat: position.coords.latitude, lng: position.coords.longitude };
            map.setCenter(userPos);

            if (!markers["usuario"]) {
              markers["usuario"] = new google.maps.Marker({
                position: userPos,
                map,
                title: "Tú estás aquí",
                icon: {
                  path: google.maps.SymbolPath.CIRCLE,
                  scale: 10,
                  fillColor: "#00FF00",
                  fillOpacity: 1,
                  strokeWeight: 2,
                  strokeColor: "#00FF00"
                }
              });
            } else {
              markers["usuario"].setPosition(userPos);
            }
          },
          (error) => console.warn("No se pudo obtener la ubicación:", error),
          { enableHighAccuracy: true }
        );
      }

      const select = document.getElementById("ruta");
      select.addEventListener("change", () => {
        const rutaSeleccionada = select.value;
        rutaSeleccionadaGlobal = rutaSeleccionada;

        // Limpiar marcadores de vehículos
        for (const key in markers) {
          if (key !== "usuario") markers[key].setMap(null);
        }

        // Limpiar listener Firebase
        if (currentRef) { off(currentRef); currentRef = null; }

        // Limpiar ruta en mapa
        if (directionsRenderer) { directionsRenderer.setMap(null); directionsRenderer = null; }

        if (!rutaSeleccionada) return;

        const polylineOptions = (rutaSeleccionada === "LM-V01") ? {
          strokeColor: "#00FF00", strokeWeight: 5
        } : (rutaSeleccionada === "LM-V01R") ? {
          strokeColor: "#FF9900", strokeWeight: 5
        } : {
          strokeColor: "#1976d2", strokeWeight: 5
        };

        directionsRenderer = new google.maps.DirectionsRenderer({
          map: map,
          suppressMarkers: true,
          polylineOptions: polylineOptions,
          preserveViewport: true
        });

        const datosRuta = obtenerDatosRuta(rutaSeleccionada);
        if (datosRuta) {
          directionsService.route({
            origin: datosRuta.origen,
            destination: datosRuta.destino,
            waypoints: datosRuta.waypoints,
            travelMode: google.maps.TravelMode.DRIVING
          }, (result, status) => {
            if (status === google.maps.DirectionsStatus.OK) {
              directionsRenderer.setDirections(result);
            } else {
              console.error("Error al trazar la ruta:", status);
            }
          });
        }

        // Escucha ubicación de conductores
        currentRef = ref(database, 'conductores/' + rutaSeleccionada);
        onValue(currentRef, (snapshot) => {
          const data = snapshot.val();
          if (!data) return;

          if (data.lat && data.lng) {
            updateMarker(rutaSeleccionada, data.lat, data.lng);
          } else {
            Object.entries(data).forEach(([id, pos]) => {
              if (pos.lat && pos.lng) updateMarker(id, pos.lat, pos.lng);
            });
          }
        });
      });
    };

    function updateMarker(id, lat, lng) {
      const busIcon = { 
        url: 'https://i.imgur.com/QByNhob.png',
        scaledSize: new google.maps.Size(50, 50),
        origin: new google.maps.Point(0, 0),
        anchor: new google.maps.Point(25, 50)
      };

      if (!markers[id]) {
        markers[id] = new google.maps.Marker({
          position: { lat, lng },
          map,
          title: id,
          icon: busIcon
        });
      } else {
        markers[id].setPosition({ lat, lng });
      }
    }

    // --- Video por ruta ---
    const btnVideo = document.getElementById('btnVideo');
    const videoModal = document.getElementById('videoModal');
    const cerrarVideo = document.getElementById('cerrarVideo');
    const videoRecorrido = document.getElementById('videoRecorrido');

    const videosPorRuta = {
      "LM-V01": "videosLM-V01.mp4",
      "LM-V01R": "videosLM-V01R.mp4",
      "C47-V1": "videosC47-V1.mp4"
    };

    btnVideo.addEventListener('click', () => {
      const rutaSeleccionada = document.getElementById('ruta').value;
      if (!rutaSeleccionada || !videosPorRuta[rutaSeleccionada]) {
        alert("Por favor selecciona una ruta primero");
        return;
      }
      videoRecorrido.src = videosPorRuta[rutaSeleccionada];
      videoModal.style.display = 'flex';
      videoRecorrido.play();
    });

    cerrarVideo.addEventListener('click', () => {
      videoModal.style.display = 'none';
      videoRecorrido.pause();
      videoRecorrido.currentTime = 0;
    });
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBm-0RbxDUhygQlvNwJSGxxbbwarll1q8o&callback=initMap">
  </script>

</body>
</html>




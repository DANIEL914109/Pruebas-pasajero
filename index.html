<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Pasajero - Moviit</title>
  <style>
    #map {
      height: 90vh;
      width: 100%;
    }
    body {
      margin: 0;
      font-family: sans-serif;
      text-align: center;
    }
    select {
      margin: 1em;
      padding: 0.5em;
      font-size: 1em;
    }
  </style>
</head>
<body>

  <h2>Ubicación del Transporte</h2>
  <label for="ruta">Selecciona la ruta:</label>
  <select id="ruta">
    <option value="">-- Elige una ruta --</option>
    <option value="LM-V01">LM-V01(Central vieja)</option>
    <option value="LM-V01R">LM-V01(La noria)</option>
    <option value="C47-V1">C47-V1(Dos templos)</option>
  </select>

  <div id="map"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, off } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCcVJ7HJM3gS10BcCNdxGmRx5ypzTizNYg",
      authDomain: "moviit-928f2.firebaseapp.com",
      databaseURL: "https://moviit-928f2-default-rtdb.firebaseio.com",
      projectId: "moviit-928f2",
      storageBucket: "moviit-928f2.appspot.com",
      messagingSenderId: "753483147976",
      appId: "1:753483147976:web:1057942a7b78444ebf13fd"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    let map;
    let markers = {};
    let currentRef = null;
    let directionsService;
    let directionsRenderer;
    let rutaSeleccionadaGlobal = null;

    function obtenerDatosRuta(rutaSeleccionada) {
      if (rutaSeleccionada === "LM-V01") {
        return {
          origen: { lat: 20.452031, lng: -103.420501 },
          destino: { lat: 20.662764, lng: -103.345814 }, 
          waypoints: [
            { location: { lat: 20.664631, lng: -103.370325 }, stopover: true },
            { location: { lat: 20.658245, lng: -103.353675 }, stopover: true },
            { location: { lat: 20.662724, lng: -103.350227 }, stopover: true },
          ]
        };
      }else if (rutaSeleccionada === "LM-V01R") {
        return {
          origen: { lat: 20.662764, lng: -103.345814 },
          destino: { lat: 20.452093, lng: -103.420612 },   
          waypoints: [
            { location: { lat: 20.663007, lng: -103.352604 }, stopover: true }, //constituyentes y calz. del aguila
            { location: { lat: 20.658398, lng: -103.353717 }, stopover: true }, //del aguila y washington
            { location: { lat: 20.665238, lng: -103.372348 }, stopover: true }, //mariano otero   
            { location: { lat: 20.476155, lng: -103.440711 }, stopover: true }, //san sebastian 
            { location: { lat: 20.467975, lng: -103.440510 }, stopover: true }, //calle higuera 
            { location: { lat: 20.458643, lng: -103.440889 }, stopover: true }, //cto metropolitano sur 20.460323, -103.425680
            { location: { lat: 20.460323, lng: -103.425680 }, stopover: true }, //cam antiguo

          ] 
        };
      }else if (rutaSeleccionada === "C47-V1") {
        return {
          origen: { lat: 20.594628, lng: -103.334091 },
          destino: { lat: 20.669754, lng: -103.347026 },    
          waypoints: [
            { location: { lat: 20.606665, lng: -103.337170  }, stopover: true }, //delicias   
            { location: { lat: 20.609337, lng: -103.336780  }, stopover: true }, // orozco  
            { location: { lat: 20.614133, lng: -103.331507 }, stopover: true }, // lauro badillo  
            { location: { lat: 20.616730, lng: -103.332171 }, stopover: true }, // rivera  
            { location: { lat: 20.621239, lng: -103.328962 }, stopover: true }, //toneles  
            { location: { lat: 20.622590, lng: -103.332670 }, stopover: true }, //compresor  
            { location: { lat: 20.623540, lng: -103.331908 }, stopover: true }, //calderas  
            { location: { lat: 20.626496, lng: -103.330191 }, stopover: true }, //lazaro cardenas
          ] // Si tienes waypoints agrégalos aquí
        };
      }
      // Puedes agregar otras rutas con sus datos aquí
      return null;
    }

    window.initMap = function () {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 19.4326, lng: -99.1332 },
        zoom: 14
      });

      directionsService = new google.maps.DirectionsService();

      const select = document.getElementById("ruta");
      select.addEventListener("change", () => {
        const rutaSeleccionada = select.value;
        rutaSeleccionadaGlobal = rutaSeleccionada;

        // Limpia marcadores
        for (const key in markers) {
          markers[key].setMap(null);
        }
        markers = {};

        // Limpia listener Firebase
        if (currentRef) {
          off(currentRef);
          currentRef = null;
        }

        // Limpia ruta en mapa
        if (directionsRenderer) {
          directionsRenderer.setMap(null);
          directionsRenderer = null;
        }

        if (!rutaSeleccionada) return;

        // Configura color según ruta seleccionada
        const polylineOptions = (rutaSeleccionada === "LM-V01") ? {
          strokeColor: "#00FF00", // Verde para T01
          strokeWeight: 5
        } : (rutaSeleccionada === "LM-V01R") ? {
          strokeColor: "#00FF00", // Verde para LM-V01R
          strokeWeight: 5
        } : {
          strokeColor: "#1976d2", // Azul para otras rutas
          strokeWeight: 5
        };

        // Crear nuevo directionsRenderer con color correspondiente
        directionsRenderer = new google.maps.DirectionsRenderer({
          map: map,
          suppressMarkers: true,
          polylineOptions: polylineOptions
        });

        const datosRuta = obtenerDatosRuta(rutaSeleccionada);
        if (datosRuta) {
          directionsService.route({
            origin: datosRuta.origen,
            destination: datosRuta.destino,
            waypoints: datosRuta.waypoints,
            travelMode: google.maps.TravelMode.DRIVING
          }, (result, status) => {
            if (status === google.maps.DirectionsStatus.OK) {
              directionsRenderer.setDirections(result);
              ajustarCamara(result, []);
            } else {
              console.error("Error al trazar la ruta:", status);
            }
          });
        }

        // Escucha ubicación de conductores
        currentRef = ref(database, 'conductores/' + rutaSeleccionada);
        onValue(currentRef, (snapshot) => {
          const data = snapshot.val();
          if (!data) return;

          const posiciones = [];

          if (data.lat && data.lng) {
            updateMarker(rutaSeleccionada, data.lat, data.lng);
            posiciones.push({ lat: data.lat, lng: data.lng });
          } else {
            Object.entries(data).forEach(([id, pos]) => {
              if (pos.lat && pos.lng) {
                updateMarker(id, pos.lat, pos.lng);
                posiciones.push({ lat: pos.lat, lng: pos.lng });
              }
            });
          }

          if (directionsRenderer && directionsRenderer.getDirections()) {
            ajustarCamara(directionsRenderer.getDirections(), posiciones);
          }
        });
      });
    };

    function updateMarker(id, lat, lng) {
      const busIcon = { 
        url: 'https://i.imgur.com/QByNhob.png', // Ícono de autobús público
        scaledSize: new google.maps.Size(30, 30), // Tamaño del ícono
        origin: new google.maps.Point(0, 0),
        anchor: new google.maps.Point(20, 40) // Ancla el icono al centro base
      };

      if (!markers[id]) {
        markers[id] = new google.maps.Marker({
          position: { lat, lng },
          map,
          title: id,
          icon: busIcon
        });
      } else {
        markers[id].setPosition({ lat, lng });
      }
    }

    function ajustarCamara(directionsResult, posicionesVehiculos) {
      const bounds = new google.maps.LatLngBounds();

      // Añade todos los puntos de la ruta
      const route = directionsResult.routes[0];
      route.overview_path.forEach(point => bounds.extend(point));

      // Añade posiciones de vehículos
      posicionesVehiculos.forEach(pos => bounds.extend(pos));

      map.fitBounds(bounds);
    }
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBm-0RbxDUhygQlvNwJSGxxbbwarll1q8o&callback=initMap">
  </script>

</body>
</html>
